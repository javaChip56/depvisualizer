@page
@model dependencies_visualizer.Pages.Preview.IndexModel
@{
    ViewData["Title"] = "Preview";
}

<p class="text-muted mb-3">
    Project: <strong>@Model.CurrentProject?.Name</strong> / Sub Project: <strong>@Model.CurrentSubProject?.Name</strong>
    <a class="ms-2" asp-page="/Projects/Index">Switch project</a>
</p>

<h2>Dependency Graph Preview</h2>

<div class="d-flex gap-2 flex-wrap mb-3">
    <button id="btnRecenter" type="button" class="btn btn-outline-secondary btn-sm">Recenter</button>
    <button id="btnExportPng" type="button" class="btn btn-outline-primary btn-sm">Export PNG</button>
    <button id="btnExportJpg" type="button" class="btn btn-outline-primary btn-sm">Export JPG</button>
    <button id="btnExportSvg" type="button" class="btn btn-outline-primary btn-sm">Export SVG</button>
    @if (!Model.IsMaintainer)
    {
        <button id="btnResetLayout" type="button" class="btn btn-outline-warning btn-sm">Reset Layout</button>
    }
</div>
<p class="text-muted small">
    @(Model.IsMaintainer
        ? "Layout changes are shared with all project members."
        : "Layout changes are personal to your account. Use Reset Layout to revert to the maintainer layout.")
</p>

<div id="cy" class="graph-surface"></div>

@section Scripts {
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-svg/cytoscape-svg.js"></script>
    <script>
        const elements = @Html.Raw(Model.CytoscapeElementsJson);
        const projectName = '@(Model.CurrentProject?.Name ?? "dependency-graph")';
        const isMaintainer = @Model.IsMaintainer.ToString().ToLowerInvariant();

        function sanitizeFileName(name) {
            return (name || "dependency-graph")
                .replace(/[<>:"/\\|?*\x00-\x1F]/g, "_")
                .replace(/\s+/g, "_")
                .replace(/_+/g, "_");
        }

        function downloadDataUri(filename, dataUri) {
            const a = document.createElement('a');
            a.href = dataUri;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function hasPresetPositions(graphElements) {
            const nodeElements = graphElements
                .filter(e => e.data && e.data.id && e.data.id.startsWith('n'));

            if (nodeElements.length === 0) {
                return false;
            }

            return nodeElements.every(e =>
                e.position &&
                Number.isFinite(e.position.x) &&
                Number.isFinite(e.position.y));
        }

        async function savePositions(cy) {
            const positions = {};
            cy.nodes().forEach(node => {
                const p = node.position();
                positions[node.id()] = { x: p.x, y: p.y };
            });

            const response = await fetch('@Html.Raw(Url.Page("/Preview/Index", "SaveLayout", new { subProjectId = Model.SubProjectId }))', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(positions)
            });

            if (!response.ok) {
                return;
            }

            const payload = await response.json();
            if (!payload.success) {
                console.warn(payload.error || 'Unable to save layout.');
            }
        }

        let saveTimer = null;
        function queueSave(cy) {
            if (saveTimer) {
                clearTimeout(saveTimer);
            }
            saveTimer = setTimeout(() => {
                savePositions(cy);
            }, 250);
        }

        const shouldUsePreset = hasPresetPositions(elements);
        const hasCompoundHierarchy = elements.some(e => e.data && e.data.parent);
        const layoutConfig = shouldUsePreset
            ? {
                name: 'preset',
                fit: true,
                padding: 20
            }
            : {
                // First-load layout tuning: avoid overlap while keeping clusters reasonably compact.
                name: 'cose',
                fit: true,
                animate: false,
                padding: hasCompoundHierarchy ? 20 : 30,
                nodeDimensionsIncludeLabels: true,
                avoidOverlap: true,
                avoidOverlapPadding: hasCompoundHierarchy ? 10 : 18,
                idealEdgeLength: hasCompoundHierarchy ? 60 : 90,
                edgeElasticity: 120,
                nodeRepulsion: hasCompoundHierarchy ? 130000 : 450000,
                componentSpacing: hasCompoundHierarchy ? 25 : 60,
                nestingFactor: hasCompoundHierarchy ? 0.7 : 1.1,
                gravity: hasCompoundHierarchy ? 1.8 : 1,
                numIter: 1200
            };

        if (window.cytoscape && window.cytoscapeSvg) {
            window.cytoscape.use(window.cytoscapeSvg);
        }

        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements,
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': 'data(fillColor)',
                        'background-opacity': 1,
                        'border-width': 1,
                        'border-color': 'data(lineColor)',
                        'shape': 'data(shape)',
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-size': '8px',
                        'text-wrap': 'none',
                        'color': '#000000'
                    }
                },
                {
                    selector: 'node[isCompoundType = false]',
                    style: {
                        'width': 'label',
                        'height': 26,
                        'padding-left': 10,
                        'padding-right': 10
                    }
                },
                {
                    selector: 'node:parent',
                    style: {
                        'background-opacity': 0.2,
                        'border-style': 'dashed',
                        'text-valign': 'top',
                        'text-halign': 'center',
                        'padding': '20px'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'curve-style': 'taxi',
                        'taxi-direction': 'auto',
                        'taxi-turn': 30,
                        'target-arrow-shape': 'triangle',
                        'line-color': '#6c757d',
                        'target-arrow-color': '#6c757d',
                        'width': 1,
                        'label': 'data(label)',
                        'font-size': '10px',
                        'text-background-color': '#ffffff',
                        'text-background-opacity': 1,
                        'text-background-padding': '2px'
                    }
                }
            ],
            layout: layoutConfig
        });

        cy.on('dragfree', 'node', () => queueSave(cy));
        cy.on('layoutstop', () => queueSave(cy));

        document.getElementById('btnRecenter')?.addEventListener('click', () => {
            cy.fit(undefined, 30);
            cy.center();
        });

        document.getElementById('btnExportPng')?.addEventListener('click', () => {
            const dataUri = cy.png({ full: true, scale: 2, bg: '#ffffff' });
            downloadDataUri(`${sanitizeFileName(projectName)}.png`, dataUri);
        });

        document.getElementById('btnExportJpg')?.addEventListener('click', () => {
            const dataUri = cy.jpg({ full: true, scale: 2, bg: '#ffffff', quality: 0.95 });
            downloadDataUri(`${sanitizeFileName(projectName)}.jpg`, dataUri);
        });

        document.getElementById('btnExportSvg')?.addEventListener('click', () => {
            if (typeof cy.svg !== 'function') {
                alert('SVG export is not available in this browser right now.');
                return;
            }

            const svg = cy.svg({ full: true, scale: 1, bg: '#ffffff' });
            const svgBlob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
            const svgUrl = URL.createObjectURL(svgBlob);
            downloadDataUri(`${sanitizeFileName(projectName)}.svg`, svgUrl);
            setTimeout(() => URL.revokeObjectURL(svgUrl), 1000);
        });

        document.getElementById('btnResetLayout')?.addEventListener('click', async () => {
            if (isMaintainer) {
                return;
            }

            const response = await fetch('@Html.Raw(Url.Page("/Preview/Index", "ResetLayout", new { subProjectId = Model.SubProjectId }))', {
                method: 'POST'
            });
            if (!response.ok) {
                alert('Unable to reset layout.');
                return;
            }

            const payload = await response.json();
            if (!payload.success) {
                alert(payload.error || 'Unable to reset layout.');
                return;
            }

            window.location.reload();
        });
    </script>
}
