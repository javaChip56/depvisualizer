@page
@model dependencies_visualizer.Pages.Nodes.IndexModel
@{
    ViewData["Title"] = "Nodes";

    var nodesByParent = Model.Nodes
        .OrderBy(n => n.Name)
        .ToLookup(n => n.ParentNodeId);

    var orderedRows = new List<(dependencies_visualizer.Models.Node Node, int Depth, bool HasChildren)>();
    var visited = new HashSet<int>();

    void AddBranch(int? parentNodeId, int depth)
    {
        var children = nodesByParent[parentNodeId];
        if (!children.Any())
        {
            return;
        }

        foreach (var child in children)
        {
            if (!visited.Add(child.Id))
            {
                continue;
            }

            var hasChildren = nodesByParent[child.Id].Any();
            orderedRows.Add((child, depth, hasChildren));
            AddBranch(child.Id, depth + 1);
        }
    }

    AddBranch(null, 0);

    foreach (var orphan in Model.Nodes.Where(n => !visited.Contains(n.Id)).OrderBy(n => n.Name))
    {
        var hasChildren = nodesByParent[orphan.Id].Any();
        orderedRows.Add((orphan, 0, hasChildren));
        AddBranch(orphan.Id, 1);
    }
}

<p class="text-muted mb-3">
    Project: <strong>@Model.CurrentProject?.Name</strong> / Sub Project: <strong>@Model.CurrentSubProject?.Name</strong>
    <a class="ms-2" asp-page="/Projects/Index">Switch project</a>
    <a class="ms-2" asp-page="/Projects/Audit" asp-route-projectId="@Model.CurrentProject?.Id">View audit</a>
</p>

<div class="row g-4">
    <div class="col-lg-5">
        <h2>@(Model.IsEditing ? "Edit Node" : "Define Node")</h2>
        <form method="post" class="card p-3">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>
            <input type="hidden" asp-for="SubProjectId" />
            <input type="hidden" asp-for="Input.Id" />

            <div class="mb-3">
                <label asp-for="Input.Name" class="form-label"></label>
                <input asp-for="Input.Name" class="form-control" />
                <span asp-validation-for="Input.Name" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="Input.Type" class="form-label">Type</label>
                <select asp-for="Input.Type" class="form-select" asp-items="Model.NodeTypeOptions">
                    <option value="">Select type</option>
                </select>
                <span asp-validation-for="Input.Type" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="Input.Description" class="form-label"></label>
                <textarea asp-for="Input.Description" class="form-control" rows="3"></textarea>
                <span asp-validation-for="Input.Description" class="text-danger"></span>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-6">
                    <label asp-for="Input.LineColor" class="form-label"></label>
                    <input asp-for="Input.LineColor" type="color" class="form-control form-control-color w-100" />
                    <span asp-validation-for="Input.LineColor" class="text-danger"></span>
                </div>
                <div class="col-6">
                    <label asp-for="Input.FillColor" class="form-label"></label>
                    <input asp-for="Input.FillColor" type="color" class="form-control form-control-color w-100" />
                    <span asp-validation-for="Input.FillColor" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="Input.ParentNodeId" class="form-label"></label>
                <select asp-for="Input.ParentNodeId" class="form-select" asp-items="Model.ParentNodeOptions">
                    <option value="">None</option>
                </select>
                <span asp-validation-for="Input.ParentNodeId" class="text-danger"></span>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">@(Model.IsEditing ? "Save Node" : "Add Node")</button>
                @if (Model.IsEditing)
                {
                    <a class="btn btn-outline-secondary" asp-page="/Nodes/Index" asp-route-subProjectId="@Model.SubProjectId">Cancel</a>
                }
            </div>
        </form>
    </div>

    <div class="col-lg-7">
        <h2>Existing Nodes</h2>
        @if (!orderedRows.Any())
        {
            <p class="text-muted">No nodes created yet.</p>
        }
        else
        {
            <table class="table table-striped align-middle" id="existing-nodes-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Colors</th>
                        <th>Description</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var row in orderedRows)
                {
                    var node = row.Node;
                    var parentId = node.ParentNodeId?.ToString() ?? string.Empty;
                    <tr class="node-row" data-node-id="@node.Id" data-parent-id="@parentId" data-has-children="@(row.HasChildren ? "true" : "false")">
                        <td style="padding-left:@(row.Depth * 1.25)rem;">
                            @if (row.Depth > 0)
                            {
                                <span class="text-muted me-1" aria-hidden="true">&#9492;</span>
                            }
                            @if (row.HasChildren)
                            {
                                <button type="button" class="btn btn-sm btn-outline-secondary py-0 node-toggle me-2" data-node-id="@node.Id" aria-expanded="true" title="Collapse/Expand" aria-label="Collapse/Expand">
                                    <span class="node-toggle-icon">&#9662;</span>
                                </button>
                            }
                            else
                            {
                                <span style="display:inline-block;width:1.75rem;"></span>
                            }
                            @node.Name
                        </td>
                        <td>@node.Type</td>
                        <td>
                            <span title="Line" style="display:inline-block;width:14px;height:14px;border:2px solid @node.LineColor;background:#fff;border-radius:3px;"></span>
                            <span title="Fill" style="display:inline-block;width:14px;height:14px;border:1px solid #adb5bd;background:@node.FillColor;border-radius:3px;margin-left:4px;"></span>
                        </td>
                        <td>@node.Description</td>
                        <td class="text-end">
                            <a class="btn btn-sm btn-outline-primary" asp-page="/Nodes/Index" asp-route-subProjectId="@Model.SubProjectId" asp-route-editId="@node.Id" title="Edit" aria-label="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path d="M12.146.854a.5.5 0 0 1 .708 0l2.292 2.292a.5.5 0 0 1 0 .708l-9.5 9.5L3 14l.646-2.646 9.5-9.5zM11.207 2 4 9.207V10h.793L12 2.793 11.207 2z"/></svg>
                            </a>
                            <form method="post" asp-page-handler="Duplicate" asp-route-subProjectId="@Model.SubProjectId" class="d-inline">
                                <input type="hidden" name="sourceId" value="@node.Id" />
                                <button type="submit" class="btn btn-sm btn-outline-secondary" title="Duplicate" aria-label="Duplicate">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path d="M4 1a2 2 0 0 0-2 2v8h1V3a1 1 0 0 1 1-1h8V1H4z"/><path d="M6 4a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H6zm0 1h6a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1z"/></svg>
                                </button>
                            </form>
                            <form method="post" asp-page-handler="Delete" asp-route-subProjectId="@Model.SubProjectId" class="d-inline" onsubmit="return confirm('Delete this node?');">
                                <input type="hidden" name="deleteId" value="@node.Id" />
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete" aria-label="Delete">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5z"/><path d="M14 3.5a1 1 0 0 1-1 1H3a1 1 0 1 1 0-2h2.5l.5-.5h4l.5.5H13a1 1 0 0 1 1 1zM4.118 5 4.5 13.5A1.5 1.5 0 0 0 6 15h4a1.5 1.5 0 0 0 1.5-1.5L11.882 5H4.118z"/></svg>
                                </button>
                            </form>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        }
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (() => {
            const table = document.getElementById("existing-nodes-table");
            if (!table) {
                return;
            }

            const getDirectChildren = (nodeId) => {
                return Array.from(table.querySelectorAll(`tr.node-row[data-parent-id="${nodeId}"]`));
            };

            const hideDescendants = (nodeId) => {
                const children = getDirectChildren(nodeId);
                children.forEach((childRow) => {
                    childRow.classList.add("d-none");
                    const childId = childRow.getAttribute("data-node-id");
                    if (!childId) {
                        return;
                    }

                    const childToggle = childRow.querySelector("button.node-toggle");
                    if (childToggle) {
                        childToggle.setAttribute("aria-expanded", "false");
                        const icon = childToggle.querySelector(".node-toggle-icon");
                        if (icon) {
                            icon.textContent = "\u25B8";
                        }
                    }

                    hideDescendants(childId);
                });
            };

            const showVisibleDescendants = (nodeId) => {
                const children = getDirectChildren(nodeId);
                children.forEach((childRow) => {
                    childRow.classList.remove("d-none");
                    const childId = childRow.getAttribute("data-node-id");
                    if (!childId) {
                        return;
                    }

                    const childToggle = childRow.querySelector("button.node-toggle");
                    if (childToggle && childToggle.getAttribute("aria-expanded") === "true") {
                        showVisibleDescendants(childId);
                    }
                });
            };

            table.addEventListener("click", (event) => {
                const toggleButton = event.target.closest("button.node-toggle");
                if (!toggleButton) {
                    return;
                }

                const nodeId = toggleButton.getAttribute("data-node-id");
                if (!nodeId) {
                    return;
                }

                const isExpanded = toggleButton.getAttribute("aria-expanded") === "true";
                const icon = toggleButton.querySelector(".node-toggle-icon");

                if (isExpanded) {
                    toggleButton.setAttribute("aria-expanded", "false");
                    if (icon) {
                        icon.textContent = "\u25B8";
                    }
                    hideDescendants(nodeId);
                } else {
                    toggleButton.setAttribute("aria-expanded", "true");
                    if (icon) {
                        icon.textContent = "\u25BE";
                    }
                    showVisibleDescendants(nodeId);
                }
            });
        })();
    </script>
}
